DROP VIEW IF EXISTS `v_prestamo`;
CREATE OR REPLACE ALGORITHM=UNDEFINED DEFINER=`root`@`localhost` SQL SECURITY DEFINER VIEW `v_prestamo` AS select `pres`.`idprestamo` AS `Id`,`pro`.`nombre` AS `Productor`,`pres`.`fecha_prestamo` AS `F_prestamo`,`pres`.`monto` AS `Monto`,`pres`.`fecha_pago` AS `F_vencimiento`,sum(`a`.`monto_pago`) AS `Deuda`, `pres`.`deuda` AS `T_deuda` from ((`prestamo` `pres` join `amortizacion` `a`) join `productor` `pro`) where ((`pro`.`idproductor` = `pres`.`productor_idproductor`) and (`pres`.`idprestamo` = `a`.`prestamo`)) group by `a`.`prestamo` union select `pres`.`idprestamo` AS `Id`,`pro`.`nombre` AS `Productor`,`pres`.`fecha_prestamo` AS `F_prestamo`,`pres`.`monto` AS `Monto`,`pres`.`fecha_pago` AS `F_vencimiento`,0 AS `Deuda` from (`prestamo` `pres` join `productor` `pro`) where ((`pro`.`idproductor` = `pres`.`productor_idproductor`) and (not(`pres`.`idprestamo` in (select `a`.`prestamo` from (`prestamo` `p` join `amortizacion` `a`) where (`p`.`idprestamo` = `a`.`prestamo`) group by `a`.`prestamo`)))) group by `pres`.`idprestamo`;